# Megacache üöÄ

A high-performance, thread-safe in-memory cache for managing item reservations and purchases with user limits. Specifically designed for the [NOT Back Contest](https://contest.notco.in/dev-backend) ‚Äî a backend developer competition to build a robust, high-throughput flash-sale service from scratch.

**üèÜ NOT Back Contest**: Backend engineers compete to build a robust, high-throughput flash‚Äësale service entirely from scratch. Using Go, Redis, Postgres, and Docker‚Äîwithout frameworks and with minimal dependencies‚Äîyou will implement a reliable system that sells exactly 10,000 items every hour.

Designed for scenarios requiring atomic operations, concurrent access, and automatic cleanup of expired reservations.

## Features ‚ú®

- **Thread-Safe Operations**: All operations are atomic and safe for concurrent access
- **Lock-Free Design**: Minimal locking with extensive use of Compare-And-Swap (CAS) operations
- **User Purchase Limits**: Configurable per-user purchase limits with atomic counting
- **Automatic Cleanup**: Background goroutine automatically cleans expired reservations
- **High Performance**: Optimized for high-throughput scenarios (17M+ ops/sec for checkouts)
- **Memory Efficient**: Lock-free atomic operations where possible
- **Persistence Support**: Load/save functionality for database integration

## Architecture üèóÔ∏è

### Core Components

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        MEGACACHE                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ   RESERVATIONS  ‚îÇ    ‚îÇ      USERS      ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ checkouts: map  ‚îÇ    ‚îÇ users: map      ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ [UUID]Checkout  ‚îÇ    ‚îÇ [userID]*count  ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ Protected by:   ‚îÇ    ‚îÇ Protected by:   ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ checkoutMu      ‚îÇ    ‚îÇ userMu          ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ                    LOTS ARRAY                          ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  [0] [1] [2] [3] [4] ... [N]                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   ‚Üì   ‚Üì   ‚Üì   ‚Üì   ‚Üì       ‚Üì                            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  Lot Lot Lot Lot Lot ... Lot                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  Each Lot contains atomic uint32 status:               ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ 0 = Available                                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ 1 = Reserved                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ 2 = Sold                                            ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ               BACKGROUND CLEANUP                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ   Ticker      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ     cleanupExpired()        ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  (5 seconds)  ‚îÇ    ‚îÇ                             ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ ‚Ä¢ Expired reservations      ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                       ‚îÇ ‚Ä¢ Old completed records     ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                       ‚îÇ ‚Ä¢ Status updates            ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Data Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Checkout  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ TryPurchase ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Confirm   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Delete    ‚îÇ
‚îÇ             ‚îÇ     ‚îÇ             ‚îÇ     ‚îÇ  Purchase   ‚îÇ     ‚îÇ  Checkout   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚ñº                    ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Reserve   ‚îÇ     ‚îÇ    Sold     ‚îÇ     ‚îÇ  Completed  ‚îÇ
‚îÇ   Status    ‚îÇ     ‚îÇ   Status    ‚îÇ     ‚îÇ   (Remove)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                    
       ‚ñº                    
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     
‚îÇ   Cancel    ‚îÇ     
‚îÇ  Checkout   ‚îÇ     
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     
       ‚îÇ            
       ‚ñº            
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     
‚îÇ Available   ‚îÇ     
‚îÇ  Status     ‚îÇ     
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     
```

### Thread Safety Model

#### Minimal Locking Strategy
The cache is designed with **minimal blocking** approach using:
- **Compare-And-Swap (CAS)** operations for critical atomic updates
- **Read-Write Mutexes** only for complex data structures
- **Lock-free algorithms** for high-frequency operations

#### Lock Hierarchy (Used Sparingly)
1. **userMu** (RWMutex) - Protects user purchase counters map structure only
2. **checkoutMu** (RWMutex) - Protects checkout reservations map structure only
3. **Atomic Operations** - For all lot statuses and counters (lock-free)

#### CAS-Based Operations (Lock-Free)
- **Lot Reservations**: `atomic.CompareAndSwapUint32` for status transitions
- **User Counters**: `atomic.CompareAndSwapInt64` for purchase count updates
- **Global Counters**: `atomic.AddInt64` and `atomic.LoadInt64` for statistics
- **Rollback Operations**: Precise CAS-based rollbacks without locks

```go
// Example: Lock-free lot reservation
if atomic.CompareAndSwapUint32(&lot.status, StatusAvailable, StatusReserved) {
    // Reservation successful - no locks needed!
}

// Example: Lock-free user counter increment
for {
    currentCount := atomic.LoadInt64(userCount)
    if currentCount >= c.limitPerUser {
        return 0, ErrUserLimitExceeded
    }
    if atomic.CompareAndSwapInt64(userCount, currentCount, currentCount+1) {
        return currentCount + 1, nil  // Success!
    }
    // Retry if CAS failed due to concurrent modification
}
```

## Performance Benchmarks üìä

Based on AMD Ryzen 5 8400F 6-Core Processor:

| Operation | Throughput | Latency | Lock Usage |
|-----------|------------|---------|------------|
| **Checkout** | 17.9M ops/sec | 55.82 ns/op | Minimal (map access only) |
| **TryPurchase** | 10.3M ops/sec | 134.4 ns/op | CAS-based, lock-free |
| **Mixed Operations** | 14.6M ops/sec | 68.60 ns/op | Hybrid CAS + minimal locks |

**Why So Fast?**
- **CAS Operations**: Most critical path uses lock-free Compare-And-Swap
- **Minimal Blocking**: Locks only used for map structure protection, not data
- **Atomic Counters**: All statistics and limits use atomic operations
- **Optimized Memory Layout**: Cache-friendly data structures


### Basic Usage

```go
package main

import (
    "fmt"
    "log"
    "time"
    
    "github.com/yourrepo/megacache"
)

func main() {
    // Create cache with 10000 items, max 10 purchases per user
    cache := megacache.NewMegacache(1000, 10)
    defer cache.Close()
    
    // Reserve an item
    checkout, err := cache.Checkout(userID, itemID)
    if err != nil {
        log.Fatal(err)
    }
    
    // Purchase the reserved item
    purchased, ok := cache.TryPurchase(checkout.Code)
    if !ok {
        log.Fatal("Purchase failed")
    }
    
    // Confirm the purchase
    cache.ConfirmPurchase(checkout.Code)
    
    fmt.Printf("Successfully purchased item %d\n", purchased.LotIndex)
}
```

## Configuration ‚öôÔ∏è

### Constants

```go
const checkoutTime = 3 * time.Second  // Reservation timeout
```


## Data Structures üìã

### Checkout
```go
type Checkout struct {
    Code      uuid.UUID      // Unique reservation identifier
    UserID    int64          // User who made the reservation
    LotIndex  int64          // Index of the reserved item
    ExpiresAt time.Time      // When the reservation expires
    Status    CheckoutStatus // Current reservation status
    CreatedAt time.Time      // When the reservation was created
}
```


### SaleItems (for database loading)
```go
type SaleItems struct {
    ItemID    int64  // Item identifier
    Purchased bool   // Whether the item was purchased
    UserID    int64  // User who purchased the item
}
```

## Testing üß™


```bash
# Run all tests
go test -v

# Run benchmarks
go test -bench=. -run=^$ -benchmem
```
#
**Built with ‚ù§Ô∏è specifically for the [NOT Back Contest](https://contest.notco.in/dev-backend) and high-performance applications requiring atomic reservation management.**

------

# Megacache üöÄ

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π, –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫—ç—à –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø–æ–∫—É–ø–∫–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ª–∏–º–∏—Ç–∞–º–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è [NOT Back Contest](https://contest.notco.in/dev-backend) ‚Äî —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è backend-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ flash-–ø—Ä–æ–¥–∞–∂ —Å –Ω—É–ª—è.

**üèÜ NOT Back Contest**: Backend-–∏–Ω–∂–µ–Ω–µ—Ä—ã —Å–æ—Ä–µ–≤–Ω—É—é—Ç—Å—è –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ flash-–ø—Ä–æ–¥–∞–∂ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å –Ω—É–ª—è. –ò—Å–ø–æ–ª—å–∑—É—è Go, Redis, Postgres –∏ Docker ‚Äî –±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ –∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ ‚Äî –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–¥–∞–µ—Ç —Ä–æ–≤–Ω–æ 10,000 —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞–∂–¥—ã–π —á–∞—Å.

–°–æ–∑–¥–∞–Ω –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ ‚ú®

- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- **–î–∏–∑–∞–π–Ω –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π Compare-And-Swap (CAS)
- **–õ–∏–º–∏—Ç—ã –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ª–∏–º–∏—Ç—ã –ø–æ–∫—É–ø–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º –ø–æ–¥—Å—á–µ—Ç–æ–º
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**: –§–æ–Ω–æ–≤–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
- **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (17M+ –æ–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫ –¥–ª—è —á–µ–∫–∞—É—Ç–æ–≤)
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏**: –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Ç–∞–º, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏**: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ üèóÔ∏è

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        MEGACACHE                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ   –†–ï–ó–ï–†–í–ê–¶–ò–ò    ‚îÇ    ‚îÇ   –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò  ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ checkouts: map  ‚îÇ    ‚îÇ users: map      ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ [UUID]Checkout  ‚îÇ    ‚îÇ [userID]*count  ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ –ó–∞—â–∏—â–µ–Ω–æ:       ‚îÇ    ‚îÇ –ó–∞—â–∏—â–µ–Ω–æ:       ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ checkoutMu      ‚îÇ    ‚îÇ userMu          ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ                   –ú–ê–°–°–ò–í –õ–û–¢–û–í                         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  [0] [1] [2] [3] [4] ... [N]                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   ‚Üì   ‚Üì   ‚Üì   ‚Üì   ‚Üì       ‚Üì                            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –õ–æ—Ç –õ–æ—Ç –õ–æ—Ç –õ–æ—Ç –õ–æ—Ç ... –õ–æ—Ç                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ö–∞–∂–¥—ã–π –ª–æ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã–π uint32 —Å—Ç–∞—Ç—É—Å:          ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ 0 = –î–æ—Å—Ç—É–ø–µ–Ω                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ 1 = –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ 2 = –ü—Ä–æ–¥–∞–Ω                                          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ              –§–û–ù–û–í–ê–Ø –û–ß–ò–°–¢–ö–ê                           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ   –¢–∏–∫–µ—Ä       ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ     cleanupExpired()        ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  (5 —Å–µ–∫—É–Ω–¥)   ‚îÇ    ‚îÇ                             ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ ‚Ä¢ –ò—Å—Ç–µ–∫—à–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏       ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                       ‚îÇ ‚Ä¢ –°—Ç–∞—Ä—ã–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                       ‚îÇ ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞        ‚îÇ  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ß–µ–∫–∞—É—Ç    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ TryPurchase ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   –£–¥–∞–ª–∏—Ç—å   ‚îÇ
‚îÇ             ‚îÇ     ‚îÇ             ‚îÇ     ‚îÇ   –ø–æ–∫—É–ø–∫—É   ‚îÇ     ‚îÇ   —á–µ–∫–∞—É—Ç    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚ñº                    ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è  ‚îÇ     ‚îÇ   –ü—Ä–æ–¥–∞–Ω–æ   ‚îÇ     ‚îÇ –ó–∞–≤–µ—Ä—à–µ–Ω–æ   ‚îÇ
‚îÇ   —Å—Ç–∞—Ç—É—Å    ‚îÇ     ‚îÇ   —Å—Ç–∞—Ç—É—Å    ‚îÇ     ‚îÇ  (–£–¥–∞–ª–∏—Ç—å)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                    
       ‚ñº                    
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     
‚îÇ  –û—Ç–º–µ–Ω–∏—Ç—å   ‚îÇ     
‚îÇ   —á–µ–∫–∞—É—Ç    ‚îÇ     
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     
       ‚îÇ            
       ‚ñº            
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     
‚îÇ  –î–æ—Å—Ç—É–ø–µ–Ω   ‚îÇ     
‚îÇ   —Å—Ç–∞—Ç—É—Å    ‚îÇ     
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     
```

### –ú–æ–¥–µ–ª—å –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
–ö—ç—à —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω —Å –ø–æ–¥—Ö–æ–¥–æ–º **–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**, –∏—Å–ø–æ–ª—å–∑—É—è:
- **Compare-And-Swap (CAS)** –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- **Read-Write –º—å—é—Ç–µ–∫—Å—ã** —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
- **–ê–ª–≥–æ—Ä–∏—Ç–º—ã –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** –¥–ª—è –≤—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### –ò–µ—Ä–∞—Ä—Ö–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ)
1. **userMu** (RWMutex) - –ó–∞—â–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É map —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **checkoutMu** (RWMutex) - –ó–∞—â–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É map —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π —á–µ–∫–∞—É—Ç–æ–≤
3. **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –î–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –ª–æ—Ç–æ–≤ –∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)

#### CAS-–æ–ø–µ—Ä–∞—Ü–∏–∏ (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
- **–†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –ª–æ—Ç–æ–≤**: `atomic.CompareAndSwapUint32` –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤
- **–°—á–µ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: `atomic.CompareAndSwapInt64` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø–æ–∫—É–ø–æ–∫
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏**: `atomic.AddInt64` –∏ `atomic.LoadInt64` –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- **–û–ø–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∫–∞—Ç–∞**: –¢–æ—á–Ω—ã–µ –æ—Ç–∫–∞—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ CAS –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

```go
// –ü—Ä–∏–º–µ—Ä: –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –ª–æ—Ç–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
if atomic.CompareAndSwapUint32(&lot.status, StatusAvailable, StatusReserved) {
    // –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã!
}

// –ü—Ä–∏–º–µ—Ä: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
for {
    currentCount := atomic.LoadInt64(userCount)
    if currentCount >= c.limitPerUser {
        return 0, ErrUserLimitExceeded
    }
    if atomic.CompareAndSwapInt64(userCount, currentCount, currentCount+1) {
        return currentCount + 1, nil  // –£—Å–ø–µ—Ö!
    }
    // –ü–æ–≤—Ç–æ—Ä, –µ—Å–ª–∏ CAS –Ω–µ —É–¥–∞–ª—Å—è –∏–∑-–∑–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
}
```

## –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üìä

–ù–∞ –±–∞–∑–µ AMD Ryzen 5 8400F 6-—è–¥–µ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞:

| –û–ø–µ—Ä–∞—Ü–∏—è | –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å | –ó–∞–¥–µ—Ä–∂–∫–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ |
|----------|------------------------|----------|--------------------------|
| **–ß–µ–∫–∞—É—Ç** | 17.9M –æ–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫ | 55.82 –Ω—Å/–æ–ø–µ—Ä–∞—Ü–∏—è | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ (—Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø –∫ map) |
| **TryPurchase** | 10.3M –æ–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫ | 134.4 –Ω—Å/–æ–ø–µ—Ä–∞—Ü–∏—è | –ù–∞ –æ—Å–Ω–æ–≤–µ CAS, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ |
| **–°–º–µ—à–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** | 14.6M –æ–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫ | 68.60 –Ω—Å/–æ–ø–µ—Ä–∞—Ü–∏—è | –ì–∏–±—Ä–∏–¥–Ω—ã–µ CAS + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ |

**–ü–æ—á–µ–º—É —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ?**
- **CAS-–æ–ø–µ—Ä–∞—Ü–∏–∏**: –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç Compare-And-Swap –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞—â–∏—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã map, –∞ –Ω–µ –¥–∞–Ω–Ω—ã—Ö
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏**: –í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ª–∏–º–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ –ø–∞–º—è—Ç–∏**: –î—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫ –∫—ç—à—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```go
package main

import (
    "fmt"
    "log"
    "time"
    
    "github.com/yourrepo/megacache"
)

func main() {
    // –°–æ–∑–¥–∞—Ç—å –∫—ç—à —Å 10000 —Ç–æ–≤–∞—Ä–∞–º–∏, –º–∞–∫—Å–∏–º—É–º 10 –ø–æ–∫—É–ø–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cache := megacache.NewMegacache(1000, 10)
    defer cache.Close()
    
    // –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
    checkout, err := cache.Checkout(userID, itemID)
    if err != nil {
        log.Fatal(err)
    }
    
    // –ö—É–ø–∏—Ç—å –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä
    purchased, ok := cache.TryPurchase(checkout.Code)
    if !ok {
        log.Fatal("–ü–æ–∫—É–ø–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å")
    }
    
    // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É
    cache.ConfirmPurchase(checkout.Code)
    
    fmt.Printf("–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω —Ç–æ–≤–∞—Ä %d\n", purchased.LotIndex)
}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚öôÔ∏è

### –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã

```go
const checkoutTime = 3 * time.Second  // –¢–∞–π–º-–∞—É—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
```

## –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö üìã

### Checkout
```go
type Checkout struct {
    Code      uuid.UUID      // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
    UserID    int64          // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–¥–µ–ª–∞–≤—à–∏–π —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
    LotIndex  int64          // –ò–Ω–¥–µ–∫—Å –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
    ExpiresAt time.Time      // –ö–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
    Status    CheckoutStatus // –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
    CreatedAt time.Time      // –ö–æ–≥–¥–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
}
```

### SaleItems (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö)
```go
type SaleItems struct {
    ItemID    int64  // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞
    Purchased bool   // –ë—ã–ª –ª–∏ —Ç–æ–≤–∞—Ä –∫—É–ø–ª–µ–Ω
    UserID    int64  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫—É–ø–∏–≤—à–∏–π —Ç–æ–≤–∞—Ä
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ üß™

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
go test -v

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏
go test -bench=. -run=^$ -benchmem
```

#

**–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è [NOT Back Contest](https://contest.notco.in/dev-backend) –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è–º–∏.**